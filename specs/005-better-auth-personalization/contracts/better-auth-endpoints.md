# Better Auth API Endpoints

**Service**: Better Auth Authentication Service (Node.js/Express)
**Base URL**: `https://book-hthon.vercel.app/api/auth` (Production)
**Base URL**: `http://localhost:3001/api/auth` (Development)

## Authentication Flow

Better Auth provides a REST API for authentication operations. All endpoints are auto-generated by Better Auth framework.

## Core Endpoints

### POST /api/auth/sign-up/email

**Description**: Create new user account with email/password

**Request**:
```json
{
  "email": "user@example.com",
  "password": "securepass123",
  "name": "John Doe"
}
```

**Response** (200 OK):
```json
{
  "user": {
    "id": "usr_123abc",
    "email": "user@example.com",
    "name": "John Doe",
    "emailVerified": false,
    "image": null,
    "createdAt": "2026-01-22T12:00:00Z"
  },
  "session": {
    "id": "sess_456def",
    "userId": "usr_123abc",
    "expiresAt": "2026-01-29T12:00:00Z",
    "token": "signed_session_token_here"
  }
}
```

**Cookies Set**:
- `better-auth.session_token`: HTTP-only, Secure, SameSite=Lax
- Expiration: 7 days

**Errors**:
- `400`: Email already exists, invalid email format, password too short
- `500`: Server error

**Client Example**:
```typescript
const response = await fetch('https://book-hthon.vercel.app/api/auth/sign-up/email', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  credentials: 'include', // REQUIRED to receive cookies
  body: JSON.stringify({
    email: 'user@example.com',
    password: 'securepass123',
    name: 'John Doe'
  })
});

const data = await response.json();
// Session cookie automatically stored by browser
```

---

### POST /api/auth/sign-in/email

**Description**: Authenticate existing user with email/password

**Request**:
```json
{
  "email": "user@example.com",
  "password": "securepass123"
}
```

**Response** (200 OK):
```json
{
  "user": {
    "id": "usr_123abc",
    "email": "user@example.com",
    "name": "John Doe",
    "emailVerified": true
  },
  "session": {
    "id": "sess_789ghi",
    "userId": "usr_123abc",
    "expiresAt": "2026-01-29T12:00:00Z",
    "token": "signed_session_token_here"
  }
}
```

**Cookies Set**: Same as sign-up

**Errors**:
- `400`: Invalid credentials (generic message, doesn't reveal if email exists)
- `500`: Server error

**Security Note**: Error messages intentionally vague to prevent user enumeration attacks.

---

### POST /api/auth/sign-out

**Description**: Invalidate current session and clear cookies

**Request**: Empty body

**Response** (200 OK):
```json
{
  "success": true
}
```

**Cookies Cleared**:
- `better-auth.session_token` deleted

**Session Table**: Session record deleted from database

**Client Example**:
```typescript
await fetch('https://book-hthon.vercel.app/api/auth/sign-out', {
  method: 'POST',
  credentials: 'include' // Send session cookie to invalidate
});

// Redirect to homepage or login page
window.location.href = '/';
```

---

### GET /api/auth/session

**Description**: Get current session status and user info

**Request**: No body (session token sent via cookie)

**Response** (200 OK) - Authenticated:
```json
{
  "session": {
    "id": "sess_789ghi",
    "userId": "usr_123abc",
    "expiresAt": "2026-01-29T12:00:00Z"
  },
  "user": {
    "id": "usr_123abc",
    "email": "user@example.com",
    "name": "John Doe",
    "emailVerified": true
  }
}
```

**Response** (200 OK) - Not Authenticated:
```json
{
  "session": null,
  "user": null
}
```

**Client Example** (React Hook):
```typescript
import { createAuthClient } from 'better-auth/react';

const authClient = createAuthClient({
  baseURL: 'https://book-hthon.vercel.app/api/auth'
});

function MyComponent() {
  const { data: session, isPending } = authClient.useSession();

  if (isPending) return <div>Loading...</div>;
  if (!session) return <div>Not logged in</div>;

  return <div>Welcome, {session.user.name}</div>;
}
```

---

### POST /api/auth/forgot-password

**Description**: Request password reset token (sent via email)

**Request**:
```json
{
  "email": "user@example.com"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "If an account exists, a password reset link has been sent"
}
```

**Note**: Response is intentionally vague to prevent user enumeration.

**Email Sent**: Contains password reset link with token (1-hour expiration)

---

### POST /api/auth/reset-password

**Description**: Reset password using token from email

**Request**:
```json
{
  "token": "reset_token_from_email",
  "password": "newsecurepass456"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "Password reset successfully"
}
```

**Errors**:
- `400`: Invalid or expired token, password too weak
- `500`: Server error

---

### POST /api/auth/verify-email

**Description**: Verify email address using verification token

**Request**:
```json
{
  "token": "verification_token_from_email"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "user": {
    "id": "usr_123abc",
    "emailVerified": true
  }
}
```

**Errors**:
- `400`: Invalid or expired token
- `500`: Server error

---

## Session Management

### Session Lifecycle

1. **Creation**: On successful sign-in or sign-up
2. **Storage**: Database (`session` table) + HTTP-only cookie
3. **Expiration**: 7 days from creation (configurable)
4. **Refresh**: Automatic if accessed within `updateAge` window (1 day)
5. **Revocation**: On sign-out or manual deletion

### Session Token Format

```
signed_session_token = HMAC-SHA256(session_id, BETTER_AUTH_SECRET)
```

**Security Properties**:
- HTTP-only (not accessible via JavaScript)
- Secure flag (HTTPS only in production)
- SameSite=Lax (CSRF protection)
- Signed with server secret (tampering detection)

### Session Validation (FastAPI Side)

```python
# FastAPI validates session by querying shared database
async def get_current_user(
    session_token: Optional[str] = Cookie(None, alias="better-auth.session_token")
):
    if not session_token:
        raise HTTPException(401, "Not authenticated")

    # Query Neon PostgreSQL
    session = await db.fetch_one(
        "SELECT user_id, expires_at FROM session WHERE token = :token",
        {"token": session_token}
    )

    if not session or session['expires_at'] < datetime.now(UTC):
        raise HTTPException(401, "Invalid or expired session")

    return session['user_id']
```

---

## CORS Configuration

### Better Auth Service

```typescript
// auth-service/index.ts
import { auth } from './auth'; // Better Auth instance
import cors from 'cors';

app.use(cors({
  origin: [
    'https://book-hthon.vercel.app',
    'http://localhost:3000' // Docusaurus dev server
  ],
  credentials: true, // REQUIRED for cookies
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));

app.all('/api/auth/*', auth.handler);
```

### Client-Side Requirements

**All fetch calls MUST include**:
```typescript
fetch(url, {
  credentials: 'include' // Send cookies cross-origin
});
```

**Better Auth React SDK** automatically includes `credentials: 'include'`.

---

## Error Response Format

### Standard Error Structure

```json
{
  "error": {
    "code": "INVALID_CREDENTIALS",
    "message": "The email or password you entered is incorrect"
  }
}
```

### Common Error Codes

| Code | HTTP Status | Description | Retryable |
|------|-------------|-------------|-----------|
| `INVALID_CREDENTIALS` | 400 | Email/password mismatch | No |
| `EMAIL_ALREADY_EXISTS` | 400 | Duplicate email on signup | No |
| `WEAK_PASSWORD` | 400 | Password < 8 characters | No |
| `INVALID_TOKEN` | 400 | Expired/invalid verification token | No |
| `SESSION_EXPIRED` | 401 | Session no longer valid | No (re-login) |
| `INTERNAL_ERROR` | 500 | Server error | Yes |

---

## Rate Limiting

### Better Auth Default Limits

| Endpoint | Limit | Window |
|----------|-------|--------|
| `/sign-up/email` | 5 requests | Per IP, per hour |
| `/sign-in/email` | 10 requests | Per IP, per 15 minutes |
| `/forgot-password` | 3 requests | Per email, per hour |
| `/reset-password` | 5 requests | Per token, total |

### Client Handling

```typescript
const response = await fetch(url, { method: 'POST', ... });

if (response.status === 429) {
  const retryAfter = response.headers.get('Retry-After');
  console.error(`Rate limited. Retry after ${retryAfter} seconds`);
}
```

---

## Testing Endpoints

### Development: Mock Users

```bash
# Create test user via curl
curl -X POST http://localhost:3001/api/auth/sign-up/email \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "testpass123",
    "name": "Test User"
  }' \
  -c cookies.txt # Save session cookie

# Use session cookie in subsequent requests
curl -X GET http://localhost:8000/api/profile \
  -b cookies.txt # Load session cookie
```

### Production: Postman/Insomnia

1. Send POST `/api/auth/sign-in/email` request
2. Capture `better-auth.session_token` from Set-Cookie header
3. Add cookie to Postman cookie jar
4. Test protected endpoints with cookie attached

---

## Security Best Practices

### Client-Side

1. **Never store session tokens in localStorage** (use cookies only)
2. **Always use HTTPS in production** (Secure cookies)
3. **Validate user input** before sending to API
4. **Handle errors gracefully** (don't expose stack traces)

### Server-Side (Better Auth Config)

1. **Strong secret** (`BETTER_AUTH_SECRET` â‰¥ 32 random characters)
2. **Email verification** enabled for production
3. **Rate limiting** configured per endpoint
4. **Database connection pooling** (Neon auto-handles)

---

## Environment Variables

### Better Auth Service (.env)

```env
# Database
DATABASE_URL=postgresql://user:pass@neon.tech/dbname?sslmode=require

# Better Auth
BETTER_AUTH_SECRET=<random-32-char-secret>
BETTER_AUTH_URL=https://book-hthon.vercel.app

# Email (optional, for verification/reset)
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASSWORD=<sendgrid-api-key>
```

### Generate Secret

```bash
openssl rand -base64 32
```

---

**API Version**: 1.0 (Better Auth v1.x)
**Last Updated**: 2026-01-22
**Documentation**: https://www.better-auth.com/docs
