openapi: 3.1.0
info:
  title: Better Auth Profile API
  description: |
    FastAPI endpoints for user profile management and personalization.

    Authentication via Better Auth session cookies.
    All endpoints require valid session token in cookie.
  version: 1.0.0
  contact:
    name: Physical AI Textbook Team
    url: https://book-hthon.vercel.app

servers:
  - url: https://api.railway.app
    description: Production (Railway)
  - url: http://localhost:8000
    description: Local development

security:
  - sessionCookie: []

paths:
  /api/profile:
    get:
      summary: Get User Profile
      description: |
        Retrieve authenticated user's background profile for content personalization.

        Session validation:
        1. Extract session token from cookie
        2. Query `session` table for valid, non-expired session
        3. Fetch user_profile linked to session.userId
      operationId: getProfile
      tags:
        - Profile
      responses:
        '200':
          description: Profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
              examples:
                beginner:
                  summary: Beginner learner profile
                  value:
                    python_experience: beginner
                    ros_experience: none
                    has_rtx_gpu: false
                    gpu_model: null
                    has_jetson: false
                    jetson_model: null
                    robot_type: null
                    learning_goals:
                      - simulation
                      - self-study
                advanced:
                  summary: Advanced researcher profile
                  value:
                    python_experience: advanced
                    ros_experience: advanced
                    has_rtx_gpu: true
                    gpu_model: RTX 4090
                    has_jetson: true
                    jetson_model: Orin AGX
                    robot_type: Unitree Go2
                    learning_goals:
                      - real-robot
                      - ai-research
                      - publication
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Profile not found (user exists but profile not created yet)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: not_found
                message: Profile not found. Please complete onboarding.
                retryable: false
        '500':
          $ref: '#/components/responses/ServerError'

    put:
      summary: Update User Profile
      description: |
        Update authenticated user's background profile.

        Validations:
        - All enum fields validated against allowed values
        - Text fields max length enforced
        - Array fields max 10 elements

        Timestamp updated automatically to NOW().
      operationId: updateProfile
      tags:
        - Profile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserProfileUpdate'
            examples:
              partialUpdate:
                summary: Update only experience levels
                value:
                  python_experience: intermediate
                  ros_experience: beginner
              fullUpdate:
                summary: Complete profile update
                value:
                  python_experience: advanced
                  ros_experience: intermediate
                  has_rtx_gpu: true
                  gpu_model: RTX 3080
                  has_jetson: false
                  jetson_model: null
                  robot_type: Custom quadruped
                  learning_goals:
                    - real-robot
                    - ai-research
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '400':
          description: Validation error (invalid enum value, field too long)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: validation_error
                message: "Invalid python_experience value. Must be one of: beginner, intermediate, advanced"
                retryable: false
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/ServerError'

    post:
      summary: Create User Profile
      description: |
        Create initial user profile after signup.

        Typically called during onboarding flow immediately after Better Auth signup.

        Idempotent: If profile already exists, returns 409 Conflict.
      operationId: createProfile
      tags:
        - Profile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserProfileCreate'
            example:
              python_experience: beginner
              ros_experience: none
              has_rtx_gpu: false
              has_jetson: false
              learning_goals:
                - simulation
      responses:
        '201':
          description: Profile created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Profile already exists for this user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: conflict
                message: Profile already exists. Use PUT to update.
                retryable: false
        '500':
          $ref: '#/components/responses/ServerError'

  /api/health:
    get:
      summary: Health Check
      description: Verify API and database connectivity
      operationId: healthCheck
      tags:
        - System
      security: []
      responses:
        '200':
          description: API healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy]
                  database:
                    type: string
                    enum: [connected]
                  timestamp:
                    type: string
                    format: date-time
              example:
                status: healthy
                database: connected
                timestamp: "2026-01-22T12:00:00Z"
        '503':
          description: Service unavailable (database connection failed)
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [unhealthy]
                  database:
                    type: string
                    enum: [disconnected]
                  error:
                    type: string
              example:
                status: unhealthy
                database: disconnected
                error: "Connection to Neon PostgreSQL failed"

components:
  securitySchemes:
    sessionCookie:
      type: apiKey
      in: cookie
      name: better-auth.session_token
      description: |
        Session token set by Better Auth service.

        Automatically sent by browser if credentials: "include" is set in fetch().

  schemas:
    UserProfile:
      type: object
      required:
        - python_experience
        - ros_experience
        - has_rtx_gpu
        - has_jetson
        - learning_goals
      properties:
        python_experience:
          type: string
          enum:
            - beginner
            - intermediate
            - advanced
          description: Python programming proficiency level
          example: intermediate
        ros_experience:
          type: string
          enum:
            - none
            - beginner
            - intermediate
            - advanced
          description: ROS 2 framework proficiency level
          example: beginner
        has_rtx_gpu:
          type: boolean
          description: Access to NVIDIA RTX GPU for training
          example: true
        gpu_model:
          type: string
          nullable: true
          maxLength: 100
          description: Specific GPU model if available
          example: RTX 4090
        has_jetson:
          type: boolean
          description: Access to NVIDIA Jetson device
          example: false
        jetson_model:
          type: string
          nullable: true
          maxLength: 100
          description: Specific Jetson model if available
          example: Orin Nano
        robot_type:
          type: string
          nullable: true
          maxLength: 100
          description: Physical robot platform (if any)
          example: Unitree Go1
        learning_goals:
          type: array
          items:
            type: string
            maxLength: 50
          maxItems: 10
          description: Learning objectives and interests
          example:
            - simulation
            - real-robot
            - ai-research

    UserProfileCreate:
      allOf:
        - $ref: '#/components/schemas/UserProfile'
      description: |
        Profile creation payload. All fields required except nullable ones.

        Defaults applied if not provided:
        - python_experience: "beginner"
        - ros_experience: "none"
        - has_rtx_gpu: false
        - has_jetson: false
        - learning_goals: []

    UserProfileUpdate:
      type: object
      description: |
        Profile update payload. All fields optional (partial update supported).

        Only provided fields will be updated. Null values explicit.
      properties:
        python_experience:
          type: string
          enum:
            - beginner
            - intermediate
            - advanced
        ros_experience:
          type: string
          enum:
            - none
            - beginner
            - intermediate
            - advanced
        has_rtx_gpu:
          type: boolean
        gpu_model:
          type: string
          nullable: true
          maxLength: 100
        has_jetson:
          type: boolean
        jetson_model:
          type: string
          nullable: true
          maxLength: 100
        robot_type:
          type: string
          nullable: true
          maxLength: 100
        learning_goals:
          type: array
          items:
            type: string
            maxLength: 50
          maxItems: 10

    ErrorResponse:
      type: object
      required:
        - error
        - message
        - retryable
      properties:
        error:
          type: string
          enum:
            - validation_error
            - server_error
            - service_unavailable
            - not_found
            - conflict
          description: Machine-readable error code
        message:
          type: string
          description: Human-readable error message
          example: Invalid session token
        retryable:
          type: boolean
          description: Whether client should retry the request
          example: false
        error_id:
          type: string
          format: uuid
          description: Unique error ID for support/debugging
          example: 550e8400-e29b-41d4-a716-446655440000

  responses:
    Unauthorized:
      description: |
        Authentication required or session invalid.

        Causes:
        - No session cookie sent
        - Session token invalid/expired
        - Session not found in database

        Client should redirect to login.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: unauthorized
            message: Invalid or expired session. Please sign in again.
            retryable: false

    ValidationError:
      description: Request validation failed (invalid field values, types, constraints)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            invalidEnum:
              summary: Invalid enum value
              value:
                error: validation_error
                message: "python_experience must be one of: beginner, intermediate, advanced"
                retryable: false
            fieldTooLong:
              summary: Field exceeds max length
              value:
                error: validation_error
                message: "gpu_model exceeds maximum length of 100 characters"
                retryable: false
            arrayTooLarge:
              summary: Array exceeds max items
              value:
                error: validation_error
                message: "learning_goals cannot exceed 10 items"
                retryable: false

    ServerError:
      description: Internal server error (database failure, unexpected exception)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: server_error
            message: An unexpected error occurred. Please try again later.
            retryable: true
            error_id: 550e8400-e29b-41d4-a716-446655440000

tags:
  - name: Profile
    description: User background profile management for personalization
  - name: System
    description: System health and monitoring endpoints
